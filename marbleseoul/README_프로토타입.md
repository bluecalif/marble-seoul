# Marble서울 프로토타입 README

## 1. 프로젝트 개요

**Marble서울**은 서울시 부동산 데이터를 기반으로 사용자에게 직관적인 시각화와 AI 기반 분석을 제공하는 Streamlit 프로토타입 애플리케이션입니다. 사용자는 지도를 통해 가격 분포를 확인하고, 챗봇과 대화하며 부동산 관련 인사이트를 얻을 수 있습니다.

본 프로토타입은 빠른 기능 구현과 검증을 거쳐, 확장성과 유지보수성을 높이기 위한 대규모 리팩토링을 완료했습니다.

## 2. 핵심 기능

### 2.1 기본 기능
- **4개 모드 기반 UI**: 전체/가격5분위/자치구선택/자치구비교 직관적 모드 전환
- **서울시 아파트 가격 시각화**: 서울시 전체 및 자치구별 평균 '국민평수(84m²)' 아파트 가격을 지도 위에 시각화
- **자치구별 랭킹 제공**: 가격을 기준으로 자치구 순위를 제공하고, 상위 구간별로 필터링하여 볼 수 있습니다.

### 2.2 고급 분석 기능 (v0.2 신규)
- **자치구별 상세 분석**: 선택된 자치구의 아파트 매매가, 연식, 세대수 등 종합 정보 제공
- **행정동별 세부 분석**: 자치구 내 행정동 단위 상세 데이터 분석
- **자치구 비교 시스템**: 
  - 인접 자치구 비교 (GeoPandas 기반 공간 분석)
  - 유사 매매가 자치구 비교 (±15% 범위 내 유사도 분석)
- **데이터 시각화**: 5개 차트를 통한 종합적 비교 분석
  - 매매가격, 건축년도, 종합비교, 세대수 비교
  - 인구 vs 매출 이중축 그래프
- **모드별 LLM 컨텍스트**: 각 분석 단계에 맞는 전문적 AI 상담 서비스

## 3. 기술 스택

- **Framework**: Streamlit
- **Data Handling**: Pandas, GeoPandas
- **Geospatial**: Shapely, Fiona
- **Visualization**: Folium, Plotly (v0.2 신규)
- **AI/LLM**: LangChain, OpenAI GPT
- **Spatial Analysis**: GeoPandas, Shapely (v0.2 신규)
- **Data Processing**: Python 3.11+, Poetry

## 4. 프로젝트 아키텍처

본 프로젝트는 유지보수성과 확장성을 위해 계층형 아키텍처로 설계되었습니다. 모든 코드는 책임과 역할에 따라 명확하게 분리되어 있습니다.

*상세한 리팩토링 계획은 `docs/리팩토링플랜.md` 및 `docs/상세플랜_20250810_리팩토링.md`를 참고하십시오.*

```
marble/marbleseoul/
├── app/                  # 애플리케이션 실행 및 오케스트레이션
│   ├── main.py           # 전체 모듈을 조율하는 메인 앱 (경량화)
│   └── langchain_chat.py # LangChain 기반 챗봇 로직
├── core/                 # 핵심 비즈니스 로직
│   ├── map_manager.py    # 지도 상태 및 렌더링 관리
│   └── cache_manager.py  # 세션 상태 및 캐시 관리
├── data/                 # 데이터 처리 계층
│   ├── loaders.py        # 데이터 로딩 (GeoDataFrame, CSV)
│   ├── processors.py     # 데이터 전처리 및 변환
│   ├── rankings.py       # 랭킹 계산 로직
│   ├── district_analyzer.py    # 자치구별 분석 (v0.2)
│   ├── dong_analyzer.py        # 행정동별 분석 (v0.2)
│   ├── spatial_analyzer.py     # 공간 분석 (인접구 탐지) (v0.2)
│   ├── comparison_engine.py    # 자치구 비교 엔진 (v0.2)
│   ├── population_analyzer.py  # 인구/매출 분석 (v0.2)
│   └── visualization.py        # Plotly 기반 차트 생성 (v0.2)
├── maps/                 # 지도 생성 및 스타일링
│   ├── base_map.py       # Folium 기본 지도 생성
│   ├── seoul_total.py    # 서울 전체 경계 지도
│   ├── gu_ranking.py     # 자치구별 랭킹 지도 (비교 모드 지원)
│   └── styles.py         # 지도 스타일(색상, 두께 등) 설정
├── ui/                   # UI 컴포넌트 계층
│   ├── layout.py         # 전체 페이지 레이아웃 설정
│   ├── map_controls.py   # 지도 컨트롤 (구간 선택 등)
│   ├── chat_interface.py # 챗봇 UI 렌더링
│   ├── data_display.py   # 데이터 테이블 표시 (v0.2)
│   └── mode_renderer.py  # 4개 모드별 UI 렌더링 (v0.2)
├── utils/                # 공통 유틸리티
│   ├── formatters.py     # 가격 포맷팅 등 순수 함수
│   └── constants.py      # 파일 경로, 설정값 등 상수
├── resources/            # 데이터 리소스
│   ├── apts/            # 아파트 관련 데이터
│   ├── maps/            # 지도 shp 파일
│   ├── opendata/        # 서울시 공공데이터
│   └── realprice/       # 실거래가 데이터
└── docs/                # 문서 및 기획서
    ├── session_logs/    # 개발 세션 로그
    └── old_plan/        # 이전 계획서들
```

### 각 디렉토리의 역할

-   **`app`**: Streamlit 애플리케이션의 진입점(`main.py`)이 위치하며, 다른 모든 모듈을 조립하고 전체 워크플로우를 관리합니다.
-   **`core`**: 애플리케이션의 핵심 두뇌 역할을 합니다. 사용자의 인터랙션에 따라 어떤 데이터를 가공하고, 어떤 지도를 보여줄지 결정하는 등 비즈니스 로직을 담당합니다.
-   **`data`**: 데이터 소스로부터 데이터를 읽고, 정제하며, 필요한 랭킹을 계산하는 등 데이터와 관련된 모든 작업을 처리합니다.
-   **`maps`**: `folium`을 사용하여 실제 지도 객체를 생성하고, 경계선을 그리거나 툴팁을 추가하는 등 지도 시각화와 관련된 코드를 포함합니다.
-   **`ui`**: 사용자에게 보여지는 화면을 구성합니다. `st.columns`로 레이아웃을 잡거나, 버튼, 슬라이더 등 Streamlit 위젯을 렌더링하는 역할을 합니다.
-   **`utils`**: 여러 모듈에서 공통적으로 사용되는 상수(파일 경로, 색상 코드 등)나 순수 함수(가격 포맷팅 등)를 모아둡니다.

## 5. 실행 방법

### 5.1 Poetry 사용 (권장)
1. Poetry가 설치되어 있는지 확인합니다.
2. 프로젝트 루트에서 의존성을 설치합니다.
   ```bash
   poetry install
   ```
3. Poetry 환경에서 애플리케이션을 실행합니다.
   ```bash
   poetry run python -m streamlit run marble/marbleseoul/app/main.py --server.port 8501
   ```

### 5.2 일반 설치 방법
1. (필요시) Python 3.11+ 가상환경을 생성하고 활성화합니다.
2. 필요한 라이브러리를 설치합니다.
   ```bash
   pip install streamlit pandas geopandas shapely folium langchain plotly fiona
   ```
3. 프로젝트 루트 디렉토리에서 아래 명령어를 실행합니다.
   ```bash
   python -m streamlit run marble/marbleseoul/app/main.py --server.port 8501
   ```

### ⭐⭐⭐ **5.3 배포 환경 시뮬레이션 (혁신적 개발 방법)** ⭐⭐⭐

**🚀🚀 중요**: 클라우드 배포 전 반드시 로컬에서 배포 환경을 시뮬레이션하여 테스트하세요!

#### **⚡ 기능 개발 단계** (빠른 테스트용):
```bash
# 프로젝트 루트에서 실행
project_root> streamlit run marbleseoul/app/main.py
```

#### **🛡️ 배포 전 필수 검증** (문제 조기 발견):
```bash
# 앱 폴더에서 직접 실행 (Streamlit Cloud 환경 시뮬레이션)
project_root/marbleseoul/app> streamlit run main.py
```

**⭐ 이 방법의 핵심 장점 ⭐**:
- ✅ **조기 문제 발견**: ModuleNotFoundError 등 배포 오류를 로컬에서 미리 차단
- ✅ **배포 안정성**: Streamlit Cloud, Heroku, AWS 등 모든 플랫폼에서 안정적 작동
- ✅ **개발 효율성**: GitHub 푸시 → 재배포 → 확인 과정 완전 생략
- ✅ **비용 절약**: 무의미한 재배포 횟수 대폭 감소

### 5.4 환경 설정
- **Python 버전**: 3.11 이상 권장
- **인코딩**: UTF-8 설정 필수 (한글 지원)
- **포트**: 기본 8501 포트 사용

## 6. 개발 히스토리

### v0.1 (2025-08-10, 프로토타입 초기 버전)
- 단일 `main.py` 파일에 모든 기능 구현
- 서울시 아파트 가격 시각화 기본 기능
- 자치구별 랭킹 및 구간 선택 기능

### v0.1.5 (2025-08-11, 리팩토링 완료)
- 확장성 및 유지보수성 확보를 위해 전체 코드 구조를 재설계 및 분리
- 계층형 아키텍처 적용 (`core`, `data`, `maps`, `ui`, `utils` 모듈 분리)
- 600줄 단일 파일을 50줄 오케스트레이션 코드로 간소화

### v0.2 (2025-08-17, 자치구 분석 기능 완료) ✅
- **자치구 선택 및 상세 분석**: 개별 자치구 심층 분석 기능
- **행정동별 세부 분석**: 자치구 내 행정동 단위 상세 정보
- **자치구 비교 시스템**: 인접 및 유사 매매가 기반 비교 분석
- **데이터 시각화**: Plotly 기반 5개 차트 시스템
- **UI 2차 최적화**: 4개 모드 기반 직관적 사용자 인터페이스
- **LLM 컨텍스트 특화**: 모드별 맞춤 AI 상담 서비스

### ⭐⭐⭐ **v0.2.1 (2025-08-17, 배포 및 개발 방법론 혁신)** ⭐⭐⭐
- **🚀 Streamlit Cloud 완전 배포**: ModuleNotFoundError 완전 해결
- **🌟 혁신적 개발 워크플로우**: 로컬에서 배포 환경 시뮬레이션 방법 개발
- **🔧 PYTHONPATH 최적화**: import 구문 이전 sys.path 설정으로 배포 안정성 확보
- **📦 Python 패키지 완성**: 모든 디렉토리 __init__.py 파일 추가
- **⚡ 개발 효율성 혁신**: GitHub 푸시 없이 배포 문제 조기 발견 시스템
- **🛡️ 범용 적용 가능**: 모든 클라우드 플랫폼 및 웹 프레임워크에 적용 가능

### 다음 계획: v0.3 (프롬프트 강화 및 고도화)
- 단계별 맞춤 LLM 프롬프트 최적화
- 시계열 분석 (월별/연도별 가격 변동 추이)
- 개인 맞춤 추천 시스템 개발

## 7. v0.2 주요 성과 및 특징

### 7.1 완료된 핵심 기능
✅ **자치구 단위 상세 분석**: 선택된 자치구의 아파트 매매가, 연식, 세대수 등 종합 정보
✅ **행정동 단위 분석**: 자치구 내 행정동별 세부 데이터 분석
✅ **자치구 비교 시스템**: 인접 및 유사 매매가 기반 비교 분석 
✅ **데이터 시각화**: Plotly 기반 5개 차트 시스템
✅ **UI 2차 최적화**: 4개 모드 기반 직관적 사용자 인터페이스
✅ **실시간 데이터 기반 LLM 상담**: 모드별 맞춤 컨텍스트
⭐⭐⭐ **Streamlit Cloud 완전 배포**: 프로덕션 환경 배포 완료 ⭐⭐⭐
⭐⭐⭐ **혁신적 개발 워크플로우**: 배포 환경 시뮬레이션 시스템 ⭐⭐⭐

### 7.2 기술적 혁신
- **GeoPandas 기반 공간 분석**: 정확한 인접 자치구 탐지
- **유사도 알고리즘**: ±15% 범위 내 매매가 유사도 계산
- **이중축 차트**: 인구(막대) + 매출(선그래프) 통합 시각화
- **모드별 세션 관리**: 안정적 상태 전환 및 캐싱 최적화
⭐⭐⭐ **PYTHONPATH 최적화**: import 구문 이전 sys.path 설정으로 배포 안정성 확보 ⭐⭐⭐
⭐⭐⭐ **배포 환경 시뮬레이션**: 로컬에서 Streamlit Cloud 환경 완벽 재현 ⭐⭐⭐
⭐⭐⭐ **Python 패키지 완성**: 프로덕션 레벨 모듈화 및 __init__.py 체계 구축 ⭐⭐⭐

### 7.3 사용자 경험 개선
- **직관적 4개 모드**: 전체/가격5분위/자치구선택/자치구비교
- **원클릭 비교**: 인접구 및 유사가격구 자동 추출 및 비교
- **실시간 반응**: 선택 즉시 지도 업데이트 및 데이터 표시
- **한글 완전 지원**: UTF-8 기반 안정적 한글 처리
⭐⭐⭐ **안정적 접근성**: Streamlit Cloud를 통한 언제 어디서나 접근 가능 ⭐⭐⭐
⭐⭐⭐ **무중단 서비스**: 배포 안정성 확보로 서비스 중단 없는 사용자 경험 ⭐⭐⭐
